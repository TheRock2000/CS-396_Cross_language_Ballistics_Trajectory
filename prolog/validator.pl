:- module(validator, [validate_solution/1]).

:- [solution].  % consult the solution.pl generated by C++

g(9.81).

deg_to_rad(Deg, Rad) :-
    Rad is Deg * pi / 180.0.

% theoretical_range(+V0, +AngleDeg, -Range)
theoretical_range(V0, AngleDeg, Range) :-
    g(G),
    deg_to_rad(AngleDeg, A),
    Range is (V0 * V0 * sin(2 * A)) / G.

% validate_solution(-Result)
% Result = ok ; Result = reject(Reason)
validate_solution(Result) :-
    solution(cartridge(Name), v0(V0), range(RGiven), angle_deg(AngleDeg)),
    (   AngleDeg =< 0.0
    ->  Result = reject(invalid_angle_non_positive(AngleDeg))
    ;   AngleDeg >= 45.0
    ->  Result = reject(invalid_angle_too_high(AngleDeg))
    ;   g(G),
        S is G * RGiven / (V0 * V0),
        (   S > 1.0
        ->  Result = reject(no_real_solution_for_range(RGiven))
        ;   theoretical_range(V0, AngleDeg, RComputed),
            Diff is abs(RComputed - RGiven),
            Tolerance is max(0.01 * RGiven, 0.1),  % 1% or at least 0.1m
            (   Diff =< Tolerance
            ->  Result = ok
            ;   Result = reject(range_mismatch(RGiven, RComputed, Diff))
            )
        )
    ),
    format('Validating solution for cartridge: ~w~n', [Name]),
    format('  v0            = ~2f m/s~n', [V0]),
    format('  given range   = ~2f m~n', [RGiven]),
    format('  angle (deg)   = ~2f~n', [AngleDeg]),
    (   Result = ok
    ->  writeln('Result: OK (solution is logically consistent).')
    ;   format('Result: REJECT (~w)~n', [Result])
    ).
